// src/components/Assignments/AsignacionReporteria.jsx
import { useState, useEffect } from 'react';
import { Camera, MapPin, Clock, Plus, Trash2 } from 'lucide-react';
import {
  getAsignacionesReporteriaByFecha,
  createAsignacionReporteria,
  updateAsignacionReporteria,
  deleteAsignacionReporteria,
} from '../../services/asignacionesService';

export const AsignacionReporteria = ({ currentDate }) => {
  const [asignaciones, setAsignaciones] = useState([]);
  const [personal, setPersonal] = useState([]);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState('camarografos'); // 'camarografos' o 'asistentes'

  // Formatear fecha sin conversión de zona horaria
  const fecha = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;

  // Cargar personal de reportería (camarógrafos y asistentes)
  useEffect(() => {
    const fetchPersonal = async () => {
      try {
        const response = await fetch('http://localhost:3000/api/personnel');
        const data = await response.json();
        const reporteria = data.filter(p =>
          p.area === 'CAMARÓGRAFOS DE REPORTERÍA' ||
          p.area === 'ASISTENTES DE REPORTERÍA'
        );
        setPersonal(reporteria);
      } catch (error) {
        console.error('Error al cargar personal:', error);
      }
    };
    fetchPersonal();
  }, []);

  // Cargar asignaciones del día
  useEffect(() => {
    loadAsignaciones();
  }, [fecha]);

  const loadAsignaciones = async () => {
    setLoading(true);
    try {
      const data = await getAsignacionesReporteriaByFecha(fecha);
      console.log('Datos recibidos del backend:', data);
      setAsignaciones(data);
    } catch (error) {
      console.error('Error al cargar asignaciones:', error);
    } finally {
      setLoading(false);
    }
  };

  // Agregar nueva asignación
  const handleAddAsignacion = async (personalId, numeroSalida) => {
    try {
      const newAsignacion = {
        id_personal: personalId,
        fecha,
        numero_salida: numeroSalida,
        hora_salida: '08:00',
        destino: 'Por definir',
        producto: 'Por definir',
        estatus: 'En Canal',
        fuera_ciudad: false,
        dias_bloqueado: 0,
        fecha_retorno: null,
        notas: ''
      };

      console.log('Creando asignación:', newAsignacion);
      const result = await createAsignacionReporteria(newAsignacion);
      console.log('Asignación creada:', result);
      loadAsignaciones();
    } catch (error) {
      console.error('Error completo al crear asignación:', error);
      alert(`Error al crear asignación: ${error.message}`);
    }
  };

  // Actualizar asignación
  const handleUpdateAsignacion = async (id, field, value) => {
    try {
      await updateAsignacionReporteria(id, { [field]: value });
      loadAsignaciones();
    } catch (error) {
      console.error('Error al actualizar asignación:', error);
      alert('Error al actualizar asignación');
    }
  };

  // Eliminar asignación
  const handleDeleteAsignacion = async (id) => {
    if (!confirm('¿Está seguro de eliminar esta asignación?')) return;

    try {
      await deleteAsignacionReporteria(id);
      loadAsignaciones();
    } catch (error) {
      console.error('Error al eliminar asignación:', error);
      alert('Error al eliminar asignación');
    }
  };

  // Obtener asignaciones de un personal específico
  const getAsignacionesPersonal = (personalId) => {
    if (!Array.isArray(asignaciones)) return [];
    const personalAsignaciones = asignaciones.find(a => a?.id_personal === personalId);
    if (!personalAsignaciones || !personalAsignaciones.asignaciones) return [];
    console.log('Asignaciones para personal', personalId, ':', personalAsignaciones.asignaciones);
    return personalAsignaciones.asignaciones;
  };

  // Componente de celda editable
  const EditableCell = ({ asignacion, field, type = 'text' }) => {
    // Para hora_salida, convertir "08:00:00" a "08:00"
    const getInitialValue = () => {
      const fieldValue = asignacion[field];
      if (field === 'hora_salida' && fieldValue) {
        return fieldValue.substring(0, 5); // "08:00:00" -> "08:00"
      }
      return fieldValue || '';
    };

    const [value, setValue] = useState(getInitialValue());
    const [isEditing, setIsEditing] = useState(false);

    const handleSave = () => {
      if (value !== getInitialValue()) {
        handleUpdateAsignacion(asignacion.id, field, value);
      }
      setIsEditing(false);
    };

    const handleKeyDown = (e) => {
      if (e.key === 'Enter') {
        handleSave();
      } else if (e.key === 'Escape') {
        setValue(asignacion[field] || '');
        setIsEditing(false);
      }
    };

    if (type === 'select') {
      return (
        <select
          value={asignacion[field]}
          onChange={(e) => handleUpdateAsignacion(asignacion.id, field, e.target.value)}
          className="w-full p-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        >
          <option value="En Canal">En Canal</option>
          <option value="En Trayecto">En Trayecto</option>
          <option value="En Locación">En Locación</option>
        </select>
      );
    }

    if (type === 'checkbox') {
      return (
        <input
          type="checkbox"
          checked={asignacion[field] || false}
          onChange={(e) => handleUpdateAsignacion(asignacion.id, field, e.target.checked)}
          className="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
        />
      );
    }

    if (isEditing) {
      return (
        <input
          type={type}
          value={value}
          onChange={(e) => setValue(e.target.value)}
          onBlur={handleSave}
          onKeyDown={handleKeyDown}
          autoFocus
          className="w-full p-2 border border-blue-500 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
      );
    }

    return (
      <div
        onClick={() => setIsEditing(true)}
        className="w-full p-2 cursor-pointer hover:bg-gray-50 rounded text-sm min-h-[2.5rem]"
      >
        {value || <span className="text-gray-400">Click para editar</span>}
      </div>
    );
  };

  // Componente de fila de asignación
  const AsignacionRow = ({ asignacion, numeroSalida }) => {
    if (!asignacion) {
      return (
        <tr className="border-b hover:bg-gray-50">
          <td className="px-4 py-3 text-center text-gray-500" colSpan="8">
            Sin asignación
          </td>
        </tr>
      );
    }

    return (
      <tr className="border-b hover:bg-gray-50">
        <td className="px-4 py-3">
          <span className="inline-flex items-center justify-center w-8 h-8 bg-blue-100 text-blue-800 rounded-full font-bold">
            {numeroSalida}
          </span>
        </td>
        <td className="px-4 py-3">
          <EditableCell asignacion={asignacion} field="hora_salida" type="time" />
        </td>
        <td className="px-4 py-3">
          <EditableCell asignacion={asignacion} field="destino" />
        </td>
        <td className="px-4 py-3">
          <EditableCell asignacion={asignacion} field="producto" />
        </td>
        <td className="px-4 py-3">
          <EditableCell asignacion={asignacion} field="estatus" type="select" />
        </td>
        <td className="px-4 py-3 text-center">
          <EditableCell asignacion={asignacion} field="fuera_ciudad" type="checkbox" />
        </td>
        <td className="px-4 py-3">
          <EditableCell asignacion={asignacion} field="notas" />
        </td>
        <td className="px-4 py-3">
          <button
            onClick={() => handleDeleteAsignacion(asignacion.id)}
            className="text-red-600 hover:text-red-800 p-2 rounded hover:bg-red-50"
            title="Eliminar asignación"
          >
            <Trash2 size={18} />
          </button>
        </td>
      </tr>
    );
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
          <p className="text-gray-600 mt-4">Cargando asignaciones...</p>
        </div>
      </div>
    );
  }

  // Determinar turno según la hora actual (solo para mostrar)
  const getTurnoActual = () => {
    const horaActual = new Date().getHours();
    // Mañana: 8:00 - 13:00, Tarde: 13:00 - 20:00
    return horaActual >= 8 && horaActual < 13 ? 'mañana' : 'tarde';
  };

  const turnoActual = getTurnoActual();

  // Filtrar personal según la pestaña activa (SIN filtrar por turno)
  const personalFiltrado = personal.filter(p => {
    if (activeTab === 'camarografos') {
      return p.area === 'CAMARÓGRAFOS DE REPORTERÍA';
    } else {
      return p.area === 'ASISTENTES DE REPORTERÍA';
    }
  });

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
            <Camera className="text-blue-600" size={28} />
            Asignación Reportería / Asistentes
          </h2>
          <p className="text-gray-600 mt-1">
            Gestión de camarógrafos y asistentes de reportería - {currentDate.toLocaleDateString('es-ES', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </p>
        </div>
        <div className="bg-blue-50 border-2 border-blue-200 rounded-lg px-4 py-2">
          <p className="text-sm text-gray-600">Turno Actual</p>
          <p className="text-lg font-bold text-blue-700 capitalize">{turnoActual}</p>
          <p className="text-xs text-gray-500">
            {turnoActual === 'mañana' ? '8:00 - 13:00' : '13:00 - 20:00'}
          </p>
        </div>
      </div>

      {/* Pestañas */}
      <div className="bg-white rounded-lg shadow-lg overflow-hidden">
        <div className="flex border-b border-gray-200">
          <button
            onClick={() => setActiveTab('camarografos')}
            className={`flex-1 px-6 py-4 text-center font-semibold transition-all ${
              activeTab === 'camarografos'
                ? 'bg-blue-600 text-white border-b-4 border-blue-800'
                : 'bg-gray-50 text-gray-600 hover:bg-gray-100'
            }`}
          >
            <Camera size={20} className="inline mr-2" />
            Camarógrafos de Reportería
          </button>
          <button
            onClick={() => setActiveTab('asistentes')}
            className={`flex-1 px-6 py-4 text-center font-semibold transition-all ${
              activeTab === 'asistentes'
                ? 'bg-blue-600 text-white border-b-4 border-blue-800'
                : 'bg-gray-50 text-gray-600 hover:bg-gray-100'
            }`}
          >
            <Camera size={20} className="inline mr-2" />
            Asistentes de Reportería
          </button>
        </div>

        {/* Contenido de la pestaña activa */}
        {personalFiltrado.length === 0 ? (
          <div className="text-center py-12 text-gray-500">
            <Camera size={48} className="mx-auto text-gray-300 mb-4" />
            <p className="text-lg">
              No hay {activeTab === 'camarografos' ? 'camarógrafos' : 'asistentes'} registrados
            </p>
          </div>
        ) : (
          personalFiltrado.map((persona) => {
            const asignacionesPersona = getAsignacionesPersonal(persona.id);

            return (
              <div key={persona.id} className="border-b last:border-b-0">
                {/* Cabecera del personal */}
                <div className="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
                  <div className="flex justify-between items-center">
                    <div className="text-white">
                      <h3 className="text-lg font-bold">{persona.name}</h3>
                      <p className="text-blue-100 text-sm">{persona.area}</p>
                    </div>
                    <div className="flex gap-2">
                      {[1, 2, 3].map((num) => {
                        const tieneAsignacion = asignacionesPersona.some(a => parseInt(a.numero_salida) === num);
                        return (
                          <button
                            key={num}
                            onClick={() => handleAddAsignacion(persona.id, num)}
                            disabled={tieneAsignacion}
                            className={`px-4 py-2 rounded-lg font-medium transition-all ${
                              tieneAsignacion
                                ? 'bg-blue-800 text-blue-300 cursor-not-allowed opacity-50'
                                : 'bg-white text-blue-600 hover:bg-blue-50'
                            }`}
                            title={tieneAsignacion ? 'Ya tiene esta salida asignada' : `Agregar salida ${num}`}
                          >
                            <Plus size={18} className="inline mr-1" />
                            Salida {num}
                          </button>
                        );
                      })}
                    </div>
                  </div>
                </div>

                {/* Tabla de salidas */}
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider w-20">
                        Salida
                      </th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider w-32">
                        <Clock size={14} className="inline mr-1" />
                        Hora
                      </th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                        <MapPin size={14} className="inline mr-1" />
                        Destino/Locación
                      </th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                        Producto/Programa
                      </th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider w-40">
                        Estatus
                      </th>
                      <th className="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider w-32">
                        Fuera Ciudad
                      </th>
                      <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                        Notas
                      </th>
                      <th className="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider w-20">
                        Acciones
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {[1, 2, 3].map((numeroSalida) => {
                      const asignacion = asignacionesPersona.find(a => parseInt(a.numero_salida) === numeroSalida);
                      console.log(`Buscando salida ${numeroSalida}, encontrado:`, asignacion);
                      return (
                        <AsignacionRow
                          key={numeroSalida}
                          asignacion={asignacion}
                          numeroSalida={numeroSalida}
                        />
                      );
                    })}
                  </tbody>
                </table>
              </div>
            );
          })
        )}
      </div>

      {/* Leyenda de estatus */}
      <div className="bg-white rounded-lg shadow p-4">
        <h4 className="text-sm font-semibold text-gray-700 mb-3">Leyenda de Estatus:</h4>
        <div className="flex gap-4">
          <div className="flex items-center gap-2">
            <div className="w-4 h-4 bg-green-100 border border-green-300 rounded"></div>
            <span className="text-sm text-gray-700">En Canal</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-4 h-4 bg-yellow-100 border border-yellow-300 rounded"></div>
            <span className="text-sm text-gray-700">En Trayecto</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-4 h-4 bg-blue-100 border border-blue-300 rounded"></div>
            <span className="text-sm text-gray-700">En Locación</span>
          </div>
        </div>
      </div>
    </div>
  );
};
